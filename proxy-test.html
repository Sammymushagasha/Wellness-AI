<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxy Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        button:hover {
            background: #5568d3;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <h1>ðŸ”§ Proxy Connection Test</h1>
    
    <p><strong>Current Status:</strong></p>
    <p id="status">Waiting to test...</p>
    
    <button onclick="testProxy()">Test Proxy Connection</button>
    <button onclick="testDirect()">Test Direct API (will fail)</button>
    <button onclick="clearLog()">Clear</button>
    
    <div id="result"></div>

    <script>
        function log(message, type = 'info') {
            const result = document.getElementById('result');
            const status = document.getElementById('status');
            result.className = type;
            result.textContent += message + '\n';
            
            if (type === 'success') {
                status.textContent = 'âœ… Proxy is working!';
                status.style.color = 'green';
            } else if (type === 'error') {
                status.textContent = 'âŒ Something is wrong';
                status.style.color = 'red';
            }
        }

        function clearLog() {
            document.getElementById('result').textContent = '';
            document.getElementById('status').textContent = 'Waiting to test...';
            document.getElementById('status').style.color = 'black';
        }

        async function testProxy() {
            clearLog();
            log('Testing proxy connection...', 'info');
            log('URL: http://localhost:3000/api/messages\n');

            try {
                log('Sending test request...');
                
                const response = await fetch('http://localhost:3000/api/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 50,
                        messages: [{
                            role: 'user',
                            content: 'Say hi in 3 words'
                        }]
                    })
                });

                log(`Response Status: ${response.status}\n`);

                if (!response.ok) {
                    const errorText = await response.text();
                    log('âŒ PROXY ERROR:', 'error');
                    log(`Status: ${response.status}`);
                    log(`Response: ${errorText}\n`);
                    
                    if (response.status === 401) {
                        log('ðŸ”‘ API Key Issue: Invalid or expired');
                        log('Check your API key in proxy-server.py');
                    } else if (response.status === 429) {
                        log('â±ï¸ Rate Limited: Wait 60 seconds');
                    }
                    return;
                }

                const data = await response.json();
                log('âœ… SUCCESS! Proxy is working correctly!', 'success');
                log('\nClaude\'s Response:');
                log(data.content[0].text);
                log('\nðŸŽ‰ Your main chatbot should work now!');
                log('If it doesn\'t, check your script.js has the correct proxy URL.');

            } catch (error) {
                log('âŒ CONNECTION ERROR:', 'error');
                log(error.toString() + '\n');

                if (error.message.includes('Failed to fetch')) {
                    log('ðŸ” TROUBLESHOOTING:');
                    log('1. Is proxy-server.py running?');
                    log('   Check terminal - should see "Server is ready!"');
                    log('2. Is it running on port 3000?');
                    log('   Check terminal output');
                    log('3. Try restarting the proxy server');
                    log('   Ctrl+C then run: python proxy-server.py');
                }
            }
        }

        async function testDirect() {
            clearLog();
            log('Testing DIRECT API call (this WILL fail due to CORS)...', 'info');
            log('This is just to show why we need the proxy.\n');

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': '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',
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 50,
                        messages: [{role: 'user', content: 'Hi'}]
                    })
                });

                log('If you see this, something is weird...', 'error');

            } catch (error) {
                log('âŒ EXPECTED CORS ERROR:', 'error');
                log(error.toString());
                log('\nThis is exactly why we need the proxy server!');
                log('The proxy at localhost:3000 fixes this issue.');
            }
        }

        // Auto-run test on load
        window.addEventListener('load', () => {
            log('Ready to test! Click "Test Proxy Connection" button.\n', 'info');
        });
    </script>
</body>
</html>
